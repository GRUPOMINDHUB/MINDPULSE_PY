{% extends 'base.html' %}

{% block title %}{{ checklist.title }} - Gerenciar - Mindpulse{% endblock %}

{% block content %}
<div class="p-4 md:p-8 bg-slate-50 dark:bg-dark-900 min-h-screen">
    <!-- Header Slim -->
    <div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4 mb-4 md:mb-6">
        <div class="flex items-center gap-3 flex-1 min-w-0">
            <a href="{% url 'checklists:manage_list' %}" 
               class="p-2 text-slate-600 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-dark-700 rounded-lg transition-all duration-200 flex-shrink-0">
                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <div class="flex-1 min-w-0">
                <h1 class="text-xl md:text-3xl font-bold text-slate-900 dark:text-white truncate">{{ checklist.title }}</h1>
                <p class="hidden md:block text-sm text-slate-600 dark:text-gray-400 mt-1">Gerencie as tarefas deste checklist</p>
            </div>
        </div>
        <a href="{% url 'checklists:edit' checklist.pk %}" 
           class="inline-flex items-center justify-center gap-2 px-4 py-3 bg-brand-100 dark:bg-brand-500/20 border border-brand-300 dark:border-brand-500/50 text-brand-600 dark:text-brand-400 rounded-xl font-medium transition-all duration-200 hover:bg-brand-200 dark:hover:bg-brand-500/30 min-h-[44px]">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            <span class="hidden sm:inline">Editar Checklist</span>
            <span class="sm:hidden">Editar</span>
        </a>
    </div>
    
    <!-- Banner de Alertas Ativos -->
    {% if pending_alerts_count > 0 %}
    <div class="mb-4 md:mb-6 bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/30 rounded-xl p-4 flex items-start gap-3">
        <div class="flex-shrink-0 mt-0.5">
            <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
        </div>
        <div class="flex-1 min-w-0">
            <p class="text-sm md:text-base font-medium text-red-900 dark:text-red-300">
                Existem {{ pending_alerts_count }} alerta(s) pendente(s) para este checklist.
            </p>
            <p class="text-xs md:text-sm text-red-700 dark:text-red-400 mt-1">
                Algumas tarefas obrigat√≥rias n√£o foram conclu√≠das pelos colaboradores.
            </p>
        </div>
        <a href="{% url 'checklists:alerts_list' %}" 
           class="flex-shrink-0 inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-all duration-200 min-h-[44px]">
            <span class="hidden sm:inline">Ver Alertas</span>
            <span class="sm:hidden">Ver</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </a>
    </div>
    {% endif %}
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8">
        <!-- Lista de Tarefas -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-xl p-4 md:p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-lg md:text-xl font-semibold text-slate-900 dark:text-white">
                        üìã Tarefas ({{ tasks.count }})
                    </h2>
                </div>
                
                <div id="tasksList" class="space-y-2 md:space-y-3">
                    {% for task in tasks %}
                    <div class="task-item flex items-center gap-2 md:gap-3 p-2 md:p-3 bg-slate-50 dark:bg-dark-900/50 rounded-lg border border-slate-200 dark:border-dark-700 group transition-all duration-200"
                         data-task-id="{{ task.pk }}"
                         data-task-order="{{ task.order }}">
                        <!-- Handle de Drag (Mobile-Friendly - w-10 h-10) -->
                        <div class="cursor-move flex-shrink-0 w-10 h-10 flex items-center justify-center text-slate-400 dark:text-gray-500 hover:text-slate-600 dark:hover:text-gray-300 transition-colors touch-manipulation">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                            </svg>
                        </div>
                        
                        <!-- Conte√∫do Slim (Sem n√∫mero de ordem no mobile) -->
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-slate-900 dark:text-white text-sm md:text-base truncate">{{ task.title }}</h4>
                            {% if task.description %}
                            <p class="hidden md:block text-xs md:text-sm text-slate-600 dark:text-gray-400 truncate mt-0.5">{{ task.description }}</p>
                            {% endif %}
                            <!-- Metadados ocultos no mobile -->
                            <div class="hidden md:flex items-center gap-2 mt-1">
                                {% if task.is_required %}
                                <span class="px-2 py-0.5 bg-brand-100 dark:bg-brand-500/20 text-brand-700 dark:text-brand-400 text-xs font-medium rounded-full">
                                    Obrigat√≥rio
                                </span>
                                {% endif %}
                                {% if task.is_active %}
                                <span class="px-2 py-0.5 bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400 text-xs font-medium rounded-full">
                                    Ativo
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Menu de A√ß√µes (Tr√™s Pontos) -->
                        <div class="flex-shrink-0 relative">
                            <button onclick="toggleTaskMenu({{ task.pk }})" 
                                    class="p-2 text-slate-400 dark:text-gray-500 hover:text-slate-600 dark:hover:text-gray-300 hover:bg-slate-100 dark:hover:bg-dark-700 rounded-lg transition-all duration-200 min-w-[44px] min-h-[44px] flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                                </svg>
                            </button>
                            
                            <!-- Dropdown Menu -->
                            <div id="taskMenu{{ task.pk }}" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-lg shadow-lg z-10">
                                <div class="py-1">
                                    <button onclick="editTask({{ task.pk }}, '{{ task.title|escapejs }}', '{{ task.description|escapejs }}', {{ task.is_required|yesno:"true,false" }}, {{ task.is_active|yesno:"true,false" }})" 
                                            class="w-full text-left px-4 py-2.5 text-sm text-slate-700 dark:text-gray-300 hover:bg-slate-50 dark:hover:bg-dark-700 transition-colors min-h-[44px] flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                        Editar
                                    </button>
                                    <button onclick="confirmDeleteTask({{ task.pk }}, '{{ task.title|escapejs }}'); closeTaskMenu({{ task.pk }});" 
                                            class="w-full text-left px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors min-h-[44px] flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-12 text-slate-600 dark:text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50 text-slate-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <p class="text-sm md:text-base">Nenhuma tarefa adicionada ainda.</p>
                        <p class="text-xs md:text-sm mt-1 text-slate-500 dark:text-gray-400">Use o campo acima para adicionar tarefas rapidamente.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Formul√°rio Completo de Adi√ß√£o (Sidebar) -->
        <div>
            <div class="bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-xl p-4 md:p-6 shadow-sm lg:sticky lg:top-8">
                <h3 class="text-base md:text-lg font-semibold text-slate-900 dark:text-white mb-4 md:mb-6">‚ûï Adicionar Tarefa</h3>
                
                {% if messages %}
                <div class="mb-4 space-y-2">
                    {% for message in messages %}
                    <div class="p-3 rounded-xl text-sm 
                                {% if message.tags == 'error' %}bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/30 text-red-700 dark:text-red-400
                                {% elif message.tags == 'success' %}bg-green-50 dark:bg-green-500/10 border border-green-200 dark:border-green-500/30 text-green-700 dark:text-green-400
                                {% else %}bg-brand-50 dark:bg-brand-500/10 border border-brand-200 dark:border-brand-500/30 text-brand-700 dark:text-brand-400{% endif %}">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if form.errors %}
                <div class="mb-4 p-3 bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/30 rounded-xl">
                    <p class="text-red-700 dark:text-red-400 font-medium mb-2 text-xs md:text-sm">Erros no formul√°rio:</p>
                    <ul class="list-disc list-inside text-xs md:text-sm text-red-600 dark:text-red-300 space-y-1">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                            <li><strong>{{ field|title }}</strong>: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <form method="post" class="space-y-4">
                    {% csrf_token %}
                    
                    <div>
                        <label for="id_title" class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">T√≠tulo *</label>
                        <input type="text" name="title" id="id_title" 
                               class="w-full px-4 py-3 bg-white dark:bg-dark-700 border border-slate-300 dark:border-dark-600 rounded-lg text-base text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-200 min-h-[44px]" 
                               placeholder="T√≠tulo da tarefa"
                               required>
                    </div>
                    
                    <div>
                        <label for="id_description" class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Descri√ß√£o</label>
                        <textarea name="description" id="id_description" 
                                  class="w-full px-4 py-3 bg-white dark:bg-dark-700 border border-slate-300 dark:border-dark-600 rounded-lg text-base text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-200 resize-none"
                                  rows="3"
                                  placeholder="Descri√ß√£o opcional"></textarea>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer min-h-[44px]">
                            <input type="checkbox" name="is_required" checked 
                                   class="w-5 h-5 rounded text-brand-500 focus:ring-brand-500 bg-white dark:bg-dark-700 border-slate-300 dark:border-dark-600 cursor-pointer">
                            <span class="text-sm text-slate-700 dark:text-gray-300">Obrigat√≥rio</span>
                        </label>
                        
                        <label class="flex items-center gap-2 cursor-pointer min-h-[44px]">
                            <input type="checkbox" name="is_active" checked 
                                   class="w-5 h-5 rounded text-brand-500 focus:ring-brand-500 bg-white dark:bg-dark-700 border-slate-300 dark:border-dark-600 cursor-pointer">
                            <span class="text-sm text-slate-700 dark:text-gray-300">Ativo</span>
                        </label>
                    </div>
                    
                    <button type="submit" 
                            class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg shadow-brand-500/25 min-h-[44px]">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Adicionar Tarefa
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edi√ß√£o de Tarefa -->
<div id="editTaskModal" class="hidden fixed inset-0 bg-slate-900/50 dark:bg-black/60 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-2xl shadow-xl max-w-md w-full p-6">
        <h3 class="text-lg md:text-xl font-bold text-slate-900 dark:text-white mb-4">Editar Tarefa</h3>
        <form id="editTaskForm" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" id="editTaskId" name="task_id">
            
            <div>
                <label for="editTaskTitle" class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">T√≠tulo *</label>
                <input type="text" id="editTaskTitle" name="title" 
                       class="w-full px-4 py-3 bg-white dark:bg-dark-700 border border-slate-300 dark:border-dark-600 rounded-lg text-base text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-200 min-h-[44px]" 
                       required>
            </div>
            
            <div>
                <label for="editTaskDescription" class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Descri√ß√£o</label>
                <textarea id="editTaskDescription" name="description" 
                          class="w-full px-4 py-3 bg-white dark:bg-dark-700 border border-slate-300 dark:border-dark-600 rounded-lg text-base text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-200 resize-none"
                          rows="3"></textarea>
            </div>
            
            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2 cursor-pointer min-h-[44px]">
                    <input type="checkbox" id="editTaskRequired" name="is_required" 
                           class="w-5 h-5 rounded text-brand-500 focus:ring-brand-500 bg-white dark:bg-dark-700 border-slate-300 dark:border-dark-600 cursor-pointer">
                    <span class="text-sm text-slate-700 dark:text-gray-300">Obrigat√≥rio</span>
                </label>
                
                <label class="flex items-center gap-2 cursor-pointer min-h-[44px]">
                    <input type="checkbox" id="editTaskActive" name="is_active" 
                           class="w-5 h-5 rounded text-brand-500 focus:ring-brand-500 bg-white dark:bg-dark-700 border-slate-300 dark:border-dark-600 cursor-pointer">
                    <span class="text-sm text-slate-700 dark:text-gray-300">Ativo</span>
                </label>
            </div>
            
            <div class="flex flex-col-reverse md:flex-row items-stretch md:items-center justify-end gap-3 pt-4">
                <button type="button" onclick="closeEditTaskModal()" 
                        class="px-4 py-2.5 md:py-3 border border-slate-300 dark:border-dark-600 text-slate-700 dark:text-gray-300 rounded-xl hover:bg-slate-50 dark:hover:bg-dark-700 transition-all duration-200 font-medium min-h-[44px]">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-4 py-2.5 md:py-3 bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white rounded-xl transition-all duration-200 font-medium shadow-lg shadow-brand-500/25 min-h-[44px]">
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o de Tarefa -->
<div id="deleteTaskModal" class="hidden fixed inset-0 bg-slate-900/50 dark:bg-black/60 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-2xl shadow-xl max-w-md w-full p-6">
        <h3 class="text-lg md:text-xl font-bold text-slate-900 dark:text-white mb-2">Confirmar Exclus√£o</h3>
        <p class="text-sm md:text-base text-slate-600 dark:text-gray-400 mb-6">
            Tem certeza que deseja excluir a tarefa "<span id="deleteTaskModalTitle" class="font-semibold text-slate-900 dark:text-white"></span>"? Esta a√ß√£o n√£o pode ser desfeita.
        </p>
        <div class="flex flex-col-reverse md:flex-row items-stretch md:items-center justify-end gap-3">
            <button onclick="closeDeleteTaskModal()" 
                    class="px-4 py-2.5 md:py-3 border border-slate-300 dark:border-dark-600 text-slate-700 dark:text-gray-300 rounded-xl hover:bg-slate-50 dark:hover:bg-dark-700 transition-all duration-200 font-medium min-h-[44px]">
                Cancelar
            </button>
            <button id="confirmDeleteTaskBtn"
                    class="px-4 py-2.5 md:py-3 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white rounded-xl transition-all duration-200 font-medium shadow-lg shadow-red-500/25 min-h-[44px]">
                Excluir
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS para drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
let taskToDelete = null;

// Toggle menu de a√ß√µes da tarefa
function toggleTaskMenu(taskId) {
    const allMenus = document.querySelectorAll('[id^="taskMenu"]');
    allMenus.forEach(menu => {
        if (menu.id !== `taskMenu${taskId}`) {
            menu.classList.add('hidden');
        }
    });
    
    const menu = document.getElementById(`taskMenu${taskId}`);
    menu.classList.toggle('hidden');
}

function closeTaskMenu(taskId) {
    const menu = document.getElementById(`taskMenu${taskId}`);
    if (menu) menu.classList.add('hidden');
}

// Fechar menus ao clicar fora
document.addEventListener('click', function(e) {
    if (!e.target.closest('[id^="taskMenu"]') && !e.target.closest('button[onclick*="toggleTaskMenu"]')) {
        document.querySelectorAll('[id^="taskMenu"]').forEach(menu => {
            menu.classList.add('hidden');
        });
    }
});

// Editar tarefa
function editTask(taskId, title, description, isRequired, isActive) {
    closeTaskMenu(taskId);
    
    document.getElementById('editTaskId').value = taskId;
    document.getElementById('editTaskTitle').value = title;
    document.getElementById('editTaskDescription').value = description || '';
    document.getElementById('editTaskRequired').checked = isRequired;
    document.getElementById('editTaskActive').checked = isActive;
    
    document.getElementById('editTaskModal').classList.remove('hidden');
}

function closeEditTaskModal() {
    document.getElementById('editTaskModal').classList.add('hidden');
}

// Submeter edi√ß√£o de tarefa
document.getElementById('editTaskForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('editTaskId').value;
    const formData = new FormData(this);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/checklists/api/task/${taskId}/edit/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEditTaskModal();
            location.reload();
        } else {
            alert(data.error || 'Erro ao editar tarefa');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao editar tarefa. Tente novamente.');
    });
});

// Excluir tarefa
function confirmDeleteTask(taskId, taskTitle) {
    taskToDelete = taskId;
    const modal = document.getElementById('deleteTaskModal');
    const titleSpan = document.getElementById('deleteTaskModalTitle');
    
    titleSpan.textContent = taskTitle;
    modal.classList.remove('hidden');
    
    const confirmBtn = document.getElementById('confirmDeleteTaskBtn');
    confirmBtn.onclick = function() {
        deleteTask(taskId);
    };
}

function closeDeleteTaskModal() {
    document.getElementById('deleteTaskModal').classList.add('hidden');
    taskToDelete = null;
}

function deleteTask(taskId) {
    if (!taskId) return;
    
    fetch(`/checklists/api/task/${taskId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: ''
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeDeleteTaskModal();
            location.reload();
        } else {
            alert(data.error || 'Erro ao excluir tarefa');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao excluir tarefa. Tente novamente.');
    });
}

// Fechar modais ao clicar fora
document.getElementById('deleteTaskModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteTaskModal();
    }
});

document.getElementById('editTaskModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditTaskModal();
    }
});

// Touch manipulation para melhor UX mobile
document.querySelectorAll('.cursor-move').forEach(handle => {
    handle.style.touchAction = 'none';
    handle.style.userSelect = 'none';
    handle.style.webkitUserSelect = 'none';
});

// Inicializa SortableJS para drag and drop
document.addEventListener('DOMContentLoaded', function() {
    const tasksList = document.getElementById('tasksList');
    
    if (tasksList) {
        const sortable = Sortable.create(tasksList, {
            handle: '.cursor-move',
            animation: 150,
            ghostClass: 'opacity-50',
            onEnd: function(evt) {
                const tasks = [];
                const taskItems = tasksList.querySelectorAll('.task-item');
                
                taskItems.forEach((item, index) => {
                    const taskId = parseInt(item.getAttribute('data-task-id'));
                    tasks.push({
                        id: taskId,
                        order: index + 1
                    });
                });
                
                // Atualiza a ordem no servidor
                fetch(`{% url "checklists:task_update_order" checklist.pk %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ tasks: tasks })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Erro ao atualizar ordem:', data.error);
                        location.reload(); // Recarrega em caso de erro
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    location.reload(); // Recarrega em caso de erro
                });
            }
        });
    }
});
</script>
{% endblock %}
