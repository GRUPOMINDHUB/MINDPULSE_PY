{% extends 'base.html' %}
{% load humanize %}

{% block title %}Gerenciar Feedbacks - Mindpulse{% endblock %}

{% block content %}
<div class="p-4 md:p-8 bg-slate-50 dark:bg-dark-900 min-h-screen">
    <!-- Header Slim -->
    <div class="mb-4 md:mb-6">
        <h1 class="text-xl md:text-3xl font-bold text-slate-900 dark:text-white mb-1 md:mb-2">Gerenciar Feedbacks</h1>
        <p class="text-sm md:text-base text-slate-600 dark:text-gray-400">Acompanhe e responda os feedbacks da sua equipe.</p>
    </div>
    
    <!-- Stats Cards - Compactos Mobile -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-6">
        <div class="bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-lg p-3 md:p-4 text-center">
            <p class="text-2xl md:text-3xl font-bold text-[#F83531]">{{ stats.total }}</p>
            <p class="text-xs md:text-sm text-slate-600 dark:text-gray-400 mt-1">Total</p>
        </div>
        <div class="bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-lg p-3 md:p-4 text-center">
            <p class="text-2xl md:text-3xl font-bold text-amber-600 dark:text-amber-400">{{ stats.pending }}</p>
            <p class="text-xs md:text-sm text-slate-600 dark:text-gray-400 mt-1">Pendentes</p>
        </div>
        <div class="bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-lg p-3 md:p-4 text-center">
            <p class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400">{{ stats.in_progress }}</p>
            <p class="text-xs md:text-sm text-slate-600 dark:text-gray-400 mt-1">Em Andamento</p>
        </div>
        <div class="bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-lg p-3 md:p-4 text-center">
            <p class="text-2xl md:text-3xl font-bold text-green-600 dark:text-green-400">{{ stats.resolved }}</p>
            <p class="text-xs md:text-sm text-slate-600 dark:text-gray-400 mt-1">Resolvidos</p>
        </div>
    </div>
    
    <!-- Filtros Mobile - Pills Deslizantes -->
    <div class="mb-4 md:mb-6">
        <!-- Mobile: Pills Horizontais Deslizantes -->
        <div class="block md:hidden overflow-x-auto pb-2 -mx-4 px-4">
            <div class="flex gap-2 min-w-max">
                <a href="{% url 'feedback:manage_list' %}{% if sentiment_filter %}?sentiment={{ sentiment_filter }}{% if category_filter %}&category={{ category_filter }}{% endif %}{% elif category_filter %}?category={{ category_filter }}{% endif %}" 
                   class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all duration-200 min-h-[44px] flex items-center justify-center {% if not status_filter %}bg-[#F83531] text-white{% else %}bg-slate-100 dark:bg-dark-700 text-slate-700 dark:text-gray-300{% endif %}">
                    Todos
                </a>
                <a href="?status=pending{% if sentiment_filter %}&sentiment={{ sentiment_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}" 
                   class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all duration-200 min-h-[44px] flex items-center justify-center {% if status_filter == 'pending' %}bg-[#F83531] text-white{% else %}bg-slate-100 dark:bg-dark-700 text-slate-700 dark:text-gray-300{% endif %}">
                    Pendentes
                </a>
                <a href="?status=resolved{% if sentiment_filter %}&sentiment={{ sentiment_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}" 
                   class="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all duration-200 min-h-[44px] flex items-center justify-center {% if status_filter == 'resolved' %}bg-[#F83531] text-white{% else %}bg-slate-100 dark:bg-dark-700 text-slate-700 dark:text-gray-300{% endif %}">
                    Respondidos
                </a>
            </div>
        </div>
        
        <!-- Desktop: Formul√°rio de Filtros Completo -->
        <div class="hidden md:block bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-lg p-4">
            <form method="get" class="flex flex-wrap items-center gap-4">
                <select name="status" class="px-4 py-2 bg-white dark:bg-dark-700 border border-slate-300 dark:border-dark-600 rounded-lg text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-brand-500 min-h-[44px]" onchange="this.form.submit()">
                    <option value="">Todos os Status</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pendente</option>
                    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>Em Andamento</option>
                    <option value="in_dialogue" {% if status_filter == 'in_dialogue' %}selected{% endif %}>Em Di√°logo</option>
                    <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Resolvido</option>
                    <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Fechado</option>
                </select>
                
                <select name="sentiment" class="px-4 py-2 bg-white dark:bg-dark-700 border border-slate-300 dark:border-dark-600 rounded-lg text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-brand-500 min-h-[44px]" onchange="this.form.submit()">
                    <option value="">Todos os Sentimentos</option>
                    <option value="great" {% if sentiment_filter == 'great' %}selected{% endif %}>üòä √ìtimo</option>
                    <option value="good" {% if sentiment_filter == 'good' %}selected{% endif %}>üôÇ Bom</option>
                    <option value="neutral" {% if sentiment_filter == 'neutral' %}selected{% endif %}>üòê Neutro</option>
                    <option value="bad" {% if sentiment_filter == 'bad' %}selected{% endif %}>üòï Ruim</option>
                    <option value="sad" {% if sentiment_filter == 'sad' %}selected{% endif %}>üò¢ Triste</option>
                </select>
                
                <select name="category" class="px-4 py-2 bg-white dark:bg-dark-700 border border-slate-300 dark:border-dark-600 rounded-lg text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-brand-500 min-h-[44px]" onchange="this.form.submit()">
                    <option value="">Todas as Categorias</option>
                    <option value="suggestion" {% if category_filter == 'suggestion' %}selected{% endif %}>Sugest√£o</option>
                    <option value="complaint" {% if category_filter == 'complaint' %}selected{% endif %}>Reclama√ß√£o</option>
                    <option value="question" {% if category_filter == 'question' %}selected{% endif %}>D√∫vida</option>
                    <option value="praise" {% if category_filter == 'praise' %}selected{% endif %}>Elogio</option>
                    <option value="other" {% if category_filter == 'other' %}selected{% endif %}>Outro</option>
                </select>
                
                {% if status_filter or sentiment_filter or category_filter %}
                <a href="{% url 'feedback:manage_list' %}" class="px-4 py-2 text-sm text-slate-600 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white min-h-[44px] flex items-center">
                    Limpar filtros
                </a>
                {% endif %}
            </form>
        </div>
    </div>
    
    <!-- Lista de Feedbacks - Cards Slim -->
    <div class="space-y-3 md:space-y-4">
        {% for feedback in feedbacks %}
        <a href="{% url 'feedback:detail' feedback.pk %}" 
           class="block bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-lg p-4 md:p-5 hover:shadow-md transition-shadow duration-200 cursor-pointer {% if feedback.status == 'pending' and feedback.is_urgent %}border-l-4 border-[#F83531]{% endif %}">
            <div class="flex flex-col md:flex-row md:items-start gap-3 md:gap-4">
                <!-- Emoji Sentimento - Mobile: Esquerda, Desktop: Esquerda -->
                <div class="text-3xl md:text-4xl flex-shrink-0">{{ feedback.sentiment_emoji }}</div>
                
                <!-- Conte√∫do Principal -->
                <div class="flex-1 min-w-0">
                    <!-- Linha 1: Assunto + Badge Status -->
                    <div class="flex items-start justify-between gap-2 mb-2">
                        <h3 class="font-semibold text-base md:text-lg text-slate-900 dark:text-white flex-1 min-w-0 truncate">
                            {{ feedback.subject }}
                        </h3>
                        <span class="px-2.5 py-1 rounded-full text-xs font-medium flex-shrink-0 whitespace-nowrap
                            {% if feedback.status == 'pending' %}bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400
                            {% elif feedback.status == 'in_progress' %}bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400
                            {% elif feedback.status == 'in_dialogue' %}bg-purple-100 text-purple-700 dark:bg-purple-500/20 dark:text-purple-400
                            {% elif feedback.status == 'resolved' %}bg-green-100 text-green-700 dark:bg-green-500/20 dark:text-green-400
                            {% else %}bg-slate-100 text-slate-700 dark:bg-slate-500/20 dark:text-slate-400{% endif %}">
                            {{ feedback.get_status_display }}
                        </span>
                    </div>
                    
                    <!-- Linha 2: Autor + Data -->
                    <div class="flex items-center gap-2 md:gap-3 mb-2 flex-wrap">
                        {% if feedback.is_anonymous %}
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-xs font-medium rounded-full">
                            üïµÔ∏è An√¥nimo
                        </span>
                        {% else %}
                        <span class="text-xs md:text-sm text-slate-600 dark:text-gray-400">
                            {{ feedback.user.get_full_name|default:feedback.user.email }}
                        </span>
                        {% endif %}
                        
                        <!-- Data Relativa no Mobile, Completa no Desktop -->
                        <span class="text-xs text-slate-500 dark:text-gray-500 hidden md:inline">
                            {{ feedback.created_at|date:"d/m/Y H:i" }}
                        </span>
                        <span class="text-xs text-slate-500 dark:text-gray-500 md:hidden" title="{{ feedback.created_at|date:"d/m/Y H:i" }}">
                            {{ feedback.created_at|naturaltime }}
                        </span>
                        
                        <!-- Badge de Urg√™ncia (pendente h√° mais de 24h) -->
                        {% if feedback.is_urgent %}
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-red-100 dark:bg-red-500/20 text-red-700 dark:text-red-400 text-xs font-medium rounded-full">
                            ‚ö†Ô∏è Urgente
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- Preview: Uma linha do conte√∫do truncada -->
                    <p class="text-sm text-slate-600 dark:text-gray-400 line-clamp-1 mb-2 md:mb-3">
                        {{ feedback.message|truncatewords:20 }}
                    </p>
                    
                    <!-- Categoria - Ocultada no Mobile -->
                    <div class="hidden md:flex items-center gap-2 flex-wrap">
                        <span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-gray-400 text-xs rounded-full">
                            {{ feedback.get_category_display }}
                        </span>
                        <!-- Badge de conversa -->
                        {% if feedback.comments.count > 0 %}
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-purple-100 dark:bg-purple-500/20 text-purple-700 dark:text-purple-400 text-xs rounded-full font-medium">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                            {{ feedback.comments.count }} mensagem{{ feedback.comments.count|pluralize:"s" }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Bot√£o Ver/Responder -->
                <button onclick="event.preventDefault(); event.stopPropagation(); window.location.href='{% url 'feedback:detail' feedback.pk %}';" 
                   class="px-4 py-2.5 bg-[#F83531] hover:bg-[#E02521] hover:brightness-110 text-white rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 min-h-[44px] whitespace-nowrap flex-shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span class="hidden md:inline">Ver Conversa</span>
                    <span class="md:hidden">Ver</span>
                </button>
            </div>
        </a>
        {% empty %}
        <div class="bg-white dark:bg-dark-800 border border-slate-200 dark:border-dark-700 rounded-lg p-12 text-center">
            <svg class="w-16 h-16 md:w-20 md:h-20 text-slate-400 dark:text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <h3 class="text-lg md:text-xl font-semibold text-slate-900 dark:text-white mb-2">Nenhum feedback encontrado</h3>
            <p class="text-sm md:text-base text-slate-600 dark:text-gray-400">Os feedbacks da equipe aparecer√£o aqui.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
